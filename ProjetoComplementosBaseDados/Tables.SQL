-- executar mkdir brightbank

select 'drop table ', table_name, 'cascade constraints;' from user_tables ;


CREATE TABLESPACE
BankingStart  DATAFILE 
'/home/oracle/brightbank/BankingStart.dat'
SIZE 1m
REUSE
AUTOEXTEND ON NEXT 1M MAXSIZE 10M;


drop tablespace BankingStart;


CREATE TABLE ENDERECO(
	NB_NEndereco NUMBER(7) GENERATED ALWAYS AS IDENTITY START WITH 1000 INCREMENT BY 1),
	VC_Rua VARCHAR2(10) NOT NULL,
	NB_CodPostal NUMBER(7) NOT NULL,
	NB_NumPorta NUMBER(2) NOT NULL,
	VC_Cidade VARCHAR2(10) NOT NULL,
	CONSTRAINT pk_ENDERECO_NEndereco PRIMARY KEY(NEndereco)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;




CREATE TABLE AGENCIA(
	NB_NAgencia NUMBER(7) GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	NB_ENDERECO_NEndreco NUMBER(7) NOT NULL,
	CONSTRAINT pk_AGENCIA_NAgencia PRIMARY KEY(NAgencia),
	CONSTRAINT fk_AGENCIA_NEndreco FOREIGN KEY(ENDERECO_NEndreco) REFERENCES ENDERECO(NEndereco)

)
TABLESPACE BankingStart
PCTFREE 0
PCTUSED 40
;

CREATE TABLE FUNCIONARIO(
	NB_NFuncionario NUMBER(7) GENERATED ALWAYS AS IDENTITY	(START WITH 1000 INCREMENT BY 1),
	NB_AGENCIA_NAgencia NUMBER(7) NOT NULL,
	VC_Gerente VARCHAR2(2) NOT NULL, --??????????????????????? não devia ser 1 pra s ou n
	CONSTRAINT pk_NFuncionario PRIMARY KEY(NFuncionario),
	CONSTRAINT fk_NAgencia FOREIGN KEY(AGENCIA_NAgencia) REFERENCES AGENCIA(NAgencia),
	CONSTRAINT ck_FUNCIONARIO_Gerente CHECK(Gerente in('S','N'))
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE CLIENTE(
	NB_iban NUMBER(16) GENERATED ALWAYS AS IDENTITY
	(START WITH 1000000000000000 INCREMENT BY 1),
	NB_idade NUMBER(3) NOT NULL,
	NB_ENDERECO_NEndreco NUMBER(7) NOT NULL,
	NB_AGENCIA_NAgencia NUMBER(7) NOT NULL,
	NB_nif NUMBER(9) NOT NULL,
	VC_nomeCliente VARCHAR2(20) NOT NULL,
	VC_profissao VARCHAR2(20) NOT NULL,
	DT_dataNasc date NOT NULL,
	VC_email VARCHAR2(20),
	VC_password VARCHAR2(10),
	CONSTRAINT cliente_pk PRIMARY KEY (iban),
	CONSTRAINT fk_NAgencia_cliente FOREIGN KEY(AGENCIA_NAgencia) REFERENCES AGENCIA(NAgencia),
	CONSTRAINT fk_NEndreco_cliente FOREIGN KEY(ENDERECO_NEndreco) REFERENCES ENDERECO(NEndereco)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE CONTA(
	NB_numeroConta NUMBER GENERATED ALWAYS AS IDENTITY (START WITH 1000000000000000 INCREMENT BY 1),
	NB_saldo NUMBER(10) NOT NULL,
	NB_titular NUMBER(16) NOT NULL,
	CONSTRAINT pk_numeroConta PRIMARY KEY (numeroConta)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;

CREATE TABLE CONTACLIENTE(
	NB_CLIENTE_IBAN NUMBER(16) NOT NULL,--numero do cliente
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT pk_contaCliente PRIMARY KEY (CLIENTE_IBAN, CONTA_numeroConta),
	CONSTRAINT fk_numeroConta   FOREIGN KEY (CONTA_numeroConta)  REFERENCES conta(numeroConta),
	CONSTRAINT fk_IBAN  FOREIGN KEY (CLIENTE_IBAN)  REFERENCES cliente(IBAN)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;



CREATE TABLE categoria(--abreviação da categoria (salario sal; creche cre; alimentação alm; Desporto des; combustíveis com; saúde sau; 
	VC_abrev_categoria VARCHAR2(3) primary key,  
	VC_nome_categoria VARCHAR2(20) NOT NULL	
)
TABLESPACE BankingStart
PCTFREE 0 
PCTUSED 40
;


CREATE TABLE TRANSACAO(
	NB_numeroTransacao NUMBER GENERATED ALWAYS AS IDENTITY	(START WITH 1000 INCREMENT BY 1),
	VC_plataforma VARCHAR2(3) NOT NULL,
	VC_CATEGORIA_abrev_categoria VARCHAR2(3) NOT NULL, 
	NB_CONTACLIENTE_Cliente_IBAN NUMBER(7) NOT NULL,
	NB_CONTACLIENTE_CONTA_numeroConta NUMBER(7) NOT NULL,
	NB_valor NUMBER(4) NOT NULL,
    	CONSTRAINT pk_numeroTransacao PRIMARY KEY (numeroTransacao),
	CONSTRAINT fk_contaCliente    FOREIGN KEY (CONTACLIENTE_CONTA_numeroConta, CONTACLIENTE_Cliente_IBAN)  REFERENCES CONTACLIENTE(CONTA_NUMEROCONTA, CLIENTE_IBAN),
	CONSTRAINT fk_abrev_categoria   FOREIGN KEY (CATEGORIA_abrev_categoria)  REFERENCES categoria(abrev_categoria),
	CONSTRAINT ck_plataforma CHECK(plataforma IN('ATM','WEB'))
    )
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;

CREATE TABLE TRANSFERENCIA(
	NB_TRANSACAO_numeroTransacao NUMBER(7) NOT NULL,
	NB_CONTA_numeroConta NUMBER(7) NOT NULL,
	CONSTRAINT fk_numeroTransacao_Transferencia     FOREIGN KEY (TRANSACAO_numeroTransacao )  REFERENCES TRANSACAO(numeroTransacao ),
	CONSTRAINT fk_numeroConta_Transferencia    FOREIGN KEY (CONTA_numeroConta)  REFERENCES CONTA(numeroConta)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;

CREATE TABLE MOVIMENTO(
	NB_TRANSACAO_numeroTransacao NUMBER(7) NOT NULL,
	VC_operacao VARCHAR2(1) NOT NULL, --levantamento e deposito
	CONSTRAINT fk_numeroTransacao_Movimento  FOREIGN KEY (TRANSACAO_numeroTransacao )  REFERENCES TRANSACAO(numeroTransacao),
	CONSTRAINT ck_operacao CHECK(operacao IN('L','D'))
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE PRODUTO(
	NB_numProduto NUMBER GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	VC_tipoProduto VARCHAR2(50), --conta jovem e o krlh
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT produto_pk PRIMARY KEY (numProduto),
	CONSTRAINT fk_NumeroConta_Produto  FOREIGN KEY (CONTA_numeroConta)  REFERENCES conta(numeroConta)
)
TABLESPACE BankingStart
PCTFREE 0 
PCTUSED 40
;

CREATE TABLE ORDEM(
	NB_CONTA_numeroConta NUMBER(7) NOT NULL,
	CONSTRAINT ordem_pk PRIMARY KEY (CONTA_numeroConta),
	CONSTRAINT fk_numeroConta_Ordem FOREIGN KEY (CONTA_numeroConta)  REFERENCES CONTA(numeroConta)
);



CREATE TABLE CARTAO(
	NB_numero NUMBER GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	NB_ORDEM_CONTA_numeroConta NUMBER NOT NULL,
	NB_pin NUMBER(4) NOT NULL,
	NB_cvv NUMBER(3) NOT NULL,
	VC_validade VARCHAR2(5) NOT NULL,
	CONSTRAINT fk_numeroConta_Cartao   FOREIGN KEY (ORDEM_CONTA_numeroConta)  REFERENCES ORDEM(CONTA_numeroConta),
	CONSTRAINT pk_numero PRIMARY KEY (numero)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


