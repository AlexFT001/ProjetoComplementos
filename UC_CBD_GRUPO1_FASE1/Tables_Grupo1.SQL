-- executar mkdir brightbank

--select 'drop table ', table_name, 'cascade constraints;' from user_tables ;

--DROP TABLESPACE BankingStart INCLUDING CONTENTS AND DATAFILES;

CREATE TABLESPACE
BankingStart  DATAFILE 
'/home/oracle/brightbank/BankingStart.dbf'
SIZE 4M
REUSE
AUTOEXTEND ON NEXT 4M;


CREATE TABLE ENDERECO(
	NB_NEndereco NUMBER(7) GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	VC_Rua VARCHAR2(10) NOT NULL,
	NB_CodPostal NUMBER(7) NOT NULL,
	NB_NumPorta NUMBER(2) NOT NULL,
	VC_Cidade VARCHAR2(10) NOT NULL,
	CONSTRAINT pk_ENDERECO_NB_NEndereco PRIMARY KEY(NB_NEndereco)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;




CREATE TABLE AGENCIA(
	NB_NAgencia NUMBER(7) GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	NB_ENDERECO_NEndreco NUMBER(7) NOT NULL,
	CONSTRAINT pk_AGENCIA_NB_NAgencia PRIMARY KEY(NB_NAgencia),
	CONSTRAINT fk_AGENCIA_NEndreco FOREIGN KEY(NB_ENDERECO_NEndreco) REFERENCES ENDERECO(NB_NEndereco)

)
TABLESPACE BankingStart
PCTFREE 0
PCTUSED 40
;

CREATE TABLE FUNCIONARIO(
	NB_NFuncionario NUMBER(7) GENERATED ALWAYS AS IDENTITY	(START WITH 1000 INCREMENT BY 1),
	NB_AGENCIA_NB_NAgencia NUMBER(7) NOT NULL,
	VC_Gerente VARCHAR2(2) NOT NULL, 
	CONSTRAINT pk_NB_NFuncionario PRIMARY KEY(NB_NFuncionario),
	CONSTRAINT fk_NB_NAgencia FOREIGN KEY(NB_AGENCIA_NB_NAgencia) REFERENCES AGENCIA(NB_NAgencia),
	CONSTRAINT ck_FUNCIONARIO_Gerente CHECK(VC_Gerente in('S','N'))
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE CLIENTE(
	NB_iban NUMBER(16) GENERATED ALWAYS AS IDENTITY (START WITH 1000000000000000 INCREMENT BY 1),
	NB_idade NUMBER(3) NOT NULL,
	NB_ENDERECO_NEndreco NUMBER(7) NOT NULL,
	NB_AGENCIA_NB_NAgencia NUMBER(7) NOT NULL,
	NB_nif NUMBER(9) NOT NULL,
	VC_nomeCliente VARCHAR2(20) NOT NULL,
	VC_profissao VARCHAR2(20) NOT NULL,
	DT_dataNasc date NOT NULL,
	VC_email VARCHAR2(20) UNIQUE,
	VC_password VARCHAR2(10),
	CONSTRAINT cliente_pk PRIMARY KEY (NB_iban),
	CONSTRAINT fk_NB_NAgencia_cliente FOREIGN KEY(NB_AGENCIA_NB_NAgencia) REFERENCES AGENCIA(NB_NAgencia),
	CONSTRAINT fk_NEndreco_cliente FOREIGN KEY(NB_ENDERECO_NEndreco) REFERENCES ENDERECO(NB_NEndereco)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE CONTA(
	NB_numeroConta NUMBER(16) GENERATED ALWAYS AS IDENTITY (START WITH 1000000000000000 INCREMENT BY 1),
	NB_saldo NUMBER(10,3) NOT NULL,
	NB_titular NUMBER(16) NOT NULL,
	CONSTRAINT pk_numeroConta PRIMARY KEY (NB_numeroConta)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;

CREATE TABLE CONTACLIENTE(
	NB_CLIENTE_IBAN NUMBER(16) NOT NULL,
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT pk_contaCliente PRIMARY KEY (NB_CLIENTE_IBAN, NB_CONTA_numeroConta),
	CONSTRAINT fk_numeroConta   FOREIGN KEY (NB_CONTA_numeroConta)  REFERENCES CONTA(NB_numeroConta),
	CONSTRAINT fk_IBAN  FOREIGN KEY (NB_CLIENTE_IBAN)  REFERENCES CLIENTE(NB_iban)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;



CREATE TABLE CATEGORIA(
	VC_abrev_categoria VARCHAR2(3) primary key,  
	VC_nome_categoria VARCHAR2(20) NOT NULL	
)
TABLESPACE BankingStart
PCTFREE 15
PCTUSED 40
;


CREATE TABLE TRANSACAO(
	NB_numeroTransacao NUMBER(7) GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	VC_plataforma VARCHAR2(3) NOT NULL,
	VC_CATEGORIA_abrev_categoria VARCHAR2(3) NOT NULL, 
	NB_CONTACLIENTE_Cliente_IBAN NUMBER(16) NOT NULL,
	NB_CONTACLIENTE_CONTA_numeroConta NUMBER(16) NOT NULL,
	NB_valor NUMBER(4,3) NOT NULL,
    CONSTRAINT pk_numeroTransacao PRIMARY KEY (NB_numeroTransacao),
	CONSTRAINT fk_contaCliente    FOREIGN KEY (NB_CONTACLIENTE_CONTA_numeroConta, NB_CONTACLIENTE_Cliente_IBAN)  REFERENCES CONTACLIENTE(NB_CONTA_numeroConta, NB_CLIENTE_IBAN),
	CONSTRAINT fk_abrev_categoria   FOREIGN KEY (VC_CATEGORIA_abrev_categoria)  REFERENCES categoria(VC_abrev_categoria),
	CONSTRAINT ck_plataforma CHECK(VC_plataforma IN('ATM','WEB'))
    )
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;

CREATE TABLE TRANSFERENCIA(
	NB_TRANSACAO_numeroTransacao NUMBER(7) NOT NULL,
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT pk_NB_TRANSACAO_numeroTransacao_Transferencia PRIMARY KEY (NB_TRANSACAO_numeroTransacao),
	CONSTRAINT fk_numeroTransacao_Transferencia     FOREIGN KEY (NB_TRANSACAO_numeroTransacao)  REFERENCES TRANSACAO(NB_numeroTransacao),
	CONSTRAINT fk_numeroConta_Transferencia    FOREIGN KEY (NB_CONTA_numeroConta)  REFERENCES CONTA(NB_numeroConta)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;

CREATE TABLE MOVIMENTO(
	NB_TRANSACAO_numeroTransacao NUMBER(7) NOT NULL,
	VC_operacao VARCHAR2(1) NOT NULL, --levantamento e deposito.
	CONSTRAINT pk_NB_TRANSACAO_numeroTransacao_Movimento PRIMARY KEY (NB_TRANSACAO_numeroTransacao),
	CONSTRAINT fk_numeroTransacao_Movimento  FOREIGN KEY (NB_TRANSACAO_numeroTransacao)  REFERENCES TRANSACAO(NB_numeroTransacao),
	CONSTRAINT ck_operacao CHECK(VC_operacao IN('L','D'))
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE PRODUTO(
	NB_numProduto NUMBER(7) GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	VC_tipoProduto VARCHAR2(50), --conta jovem, e outros.
	CONSTRAINT produto_pk PRIMARY KEY (NB_numProduto)
)
TABLESPACE BankingStart
PCTFREE 15
PCTUSED 40
;

CREATE TABLE PRODUTOCONTA(
	NB_PRODUTO_NB_numProduto NUMBER(7) NOT NULL,
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT pk_PRODUTOCONTA PRIMARY KEY (NB_PRODUTO_NB_numProduto, NB_CONTA_numeroConta),
	CONSTRAINT fk_numeroConta_Produto   FOREIGN KEY (NB_CONTA_numeroConta)  REFERENCES CONTA(NB_numeroConta),
	CONSTRAINT fk_numeroProduto  FOREIGN KEY (NB_PRODUTO_NB_numProduto)  REFERENCES PRODUTO(NB_numProduto)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


CREATE TABLE ORDEM(
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT pk_ordem PRIMARY KEY (NB_CONTA_numeroConta),
	CONSTRAINT fk_numeroConta_Ordem FOREIGN KEY (NB_CONTA_numeroConta)  REFERENCES CONTA(NB_numeroConta)
)
TABLESPACE BankingStart
PCTFREE 15
PCTUSED 40
;

CREATE TABLE PRAZO(
	NB_CONTA_numeroConta NUMBER(16) NOT NULL,
	CONSTRAINT pk_prazo PRIMARY KEY (NB_CONTA_numeroConta),
	CONSTRAINT fk_numeroConta_Prazo FOREIGN KEY (NB_CONTA_numeroConta)  REFERENCES CONTA(NB_numeroConta)
)
TABLESPACE BankingStart
PCTFREE 15
PCTUSED 40
;

CREATE TABLE CARTAO(
	NB_numero NUMBER(7) GENERATED ALWAYS AS IDENTITY (START WITH 1000 INCREMENT BY 1),
	NB_ORDEM_CONTA_numeroConta NUMBER NOT NULL,
	NB_pin NUMBER(4) NOT NULL,
	NB_cvv NUMBER(3) NOT NULL,
	VC_validade VARCHAR2(5) NOT NULL,
	CONSTRAINT fk_numeroConta_Cartao   FOREIGN KEY (NB_ORDEM_CONTA_numeroConta)  REFERENCES ORDEM(NB_CONTA_numeroConta),
	CONSTRAINT pk_numero PRIMARY KEY (NB_numero)
)
TABLESPACE BankingStart
PCTFREE 15 
PCTUSED 40
;


